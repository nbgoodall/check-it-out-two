<script>
  import { onMount } from 'svelte'
  import { PIXEL_SIZE, RESOLUTION, SCALE } from 'config/constants'

  import { Grid } from 'models'

  import { project } from 'store'

  const SIZE = PIXEL_SIZE * RESOLUTION

  let canvasEl, ctx

  onMount(() => {
    ctx = canvasEl.getContext('2d')

    ctx.scale(SCALE, SCALE)

    render()
  })

  function render() {
    $project.currentFrame.render(ctx)

    if ($project.showGrid) {
      Grid.render(ctx)
    }

    $project.tool.render(ctx, SCALE)

    requestAnimationFrame(render)
  }

  function saveImage() {
    $project.currentFrame.saveImage()

    $project.update()
  }

  function onMouseDown(evt) {
    $project.tool.mouseDown(evt)
  }

  function onMouseMove(evt) {
    $project.tool.mouseMove(evt)
  }

  function onMouseLeave(evt) {
    const isMouseDown = evt.buttons === 1

    if (isMouseDown) { saveImage() }
  }

  function onMouseUp(evt) {
    $project.tool.mouseUp(evt)

    return saveImage()
  }
</script>

<div class="select-none relative bg-white z-0" style="width: { SIZE }px; height: { SIZE }px;">
  <!-- Show checkered transparent background? IDKKK -->
  <img src="/images/grid/transparent.svg" class="absolute inset-0" alt="Transparent checkered grid.">

  {#if $project.showUnderlay && $project.frameIndex > 0 }
     <img src={ $project.previousFrame.image.src } class="absolute z-0 inset-0 opacity-25" alt="Previous frame underlay.">
  {/if}

  <canvas
    bind:this={ canvasEl }
    width={  SIZE * SCALE }
    height={ SIZE * SCALE }
    style="width: { SIZE }px; height: { SIZE }px;"
    class="absolute inset-0 z-0 cursor-{ $project.tool.cursor }"
    on:mousedown={ onMouseDown }
    on:mouseup={ onMouseUp }
    on:mouseleave={ onMouseLeave }
    on:mousemove={ onMouseMove }
  />
</div>

<style>
  .cursor-fill {
    cursor: url("/images/tools/cursor-fill.png") 2 20, auto;
  }
</style>