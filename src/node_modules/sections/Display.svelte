<script>
  import { onMount } from 'svelte'

  import { PIXEL_SIZE, RESOLUTION, SCALE } from 'config/constants'
  const SIZE = PIXEL_SIZE * RESOLUTION

  import { ImageUpload } from 'components'

  import { Grid } from 'models'

  import { project, frame, layer } from 'store'

  let canvasEl, ctx, isTarget = false

  onMount(() => {
    ctx = canvasEl.getContext('2d')

    ctx.scale(SCALE, SCALE)

    render()
  })

  function render() {
    $frame.render(ctx)

    if ($project.showGrid) {
      Grid.render(ctx)
    }

    $layer.render(ctx)

    $project.tool.render(ctx, $layer)

    requestAnimationFrame(render)
  }

  function saveImage() {
    $frame.saveImage()

    $project.update()
  }

  const event = fn => evt => {
    const {
      target,
      buttons,
      offsetX,
      offsetY,
      movementX,
      movementY,
    } = evt

    return fn({
      target,
      buttons,
      movementX,
      movementY,
      offsetX: evt.offsetX - $layer.x,
      offsetY: evt.offsetY - $layer.y,
    })
  }

  function onMouseDown(evt) {
    isTarget = evt.target === canvasEl

    $project.tool.mouseDown(evt)
  }

  function onMouseMove(evt) {
    if (evt.target === canvasEl) {
      $project.tool.mouseMove(evt)
    }

    if ($project.tool.name === 'pointer') {
      $layer.onMouseMove(evt, isTarget)
    }
  }

  function onMouseLeave(evt) {
    const isMouseDown = evt.buttons === 1

    if (isMouseDown) { saveImage() }
  }

  function onMouseUp(evt) {
    isTarget = false

    $project.tool.mouseUp(evt)

    return saveImage()
  }
</script>

<svelte:window on:mousemove={ event(onMouseMove) } />

<div class="select-none relative bg-white z-0" style="width: { SIZE }px; height: { SIZE }px;">
  <!-- Show checkered transparent background? IDKKK -->
  <img src="/images/grid/transparent.png" class="absolute inset-0" alt="Transparent checkered grid.">

  {#if $project.showUnderlay && $project.frameIndex > 0 }
     <img src={ $project.previousFrame.image.src } class="absolute z-0 inset-0 opacity-25" alt="Previous frame underlay.">
  {/if}

  <canvas
    bind:this={ canvasEl }
    width={  SIZE * SCALE }
    height={ SIZE * SCALE }
    style="width: { SIZE }px; height: { SIZE }px;"
    class="absolute inset-0 z-0 cursor-{ $project.tool.cursor }"
    on:mousedown={ event(onMouseDown) }
    on:mouseup={ event(onMouseUp) }
    on:mouseleave={ event(onMouseLeave) }
  />

  {#if canvasEl }
    <ImageUpload bind:canvasEl />
  {/if}
</div>

<style>
  .cursor-fill {
    cursor: url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 180 160" fill="black" xmlns="http://www.w3.org/2000/svg"><path d="M80 0H100V20H120V40H140V100H100V80H180V120H160V140H140V160H100V140H80V120H60V100H40V80H20V60H40V40H60V20H80V0Z" /><path d="M20 20H60V40H40V60H20V120H0V40H20V20Z" /><path d="M120 20H160V40H120V20Z" fill="%23D8D8D8"/><path d="M160 40H180V60H160V40Z" fill="%23ACACAC"/><path d="M140 60H160V80H140V60Z" fill="%23ACACAC"/><path d="M100 80H140V100H100V80Z" fill="%23ACACAC"/></svg>') 0 15, auto;
  }
</style>