<script>
  import { onMount } from 'svelte'

  import { PIXEL_SIZE, CANVAS_SIZE, SCALE } from 'config/constants'

  import tools from 'tools'

  import { ImageUpload } from 'components'

  import { Grid } from 'models'

  import { project, frame, layer, store } from 'store'

  let canvasEl, ctx, isTarget = false

  // $: {
  //   if ($store.activeLayerIds.length === 1) {
  //     activeLayer = $frame.layers[$store.activeLayerIds[0]]
  //   }
  //   else {
  //     activeLayer = null
  //   }
  // }

  onMount(() => {
    ctx = canvasEl.getContext('2d')

    ctx.scale(SCALE, SCALE)

    render()
  })

  function render() {
    $frame.render(ctx, null, !isTarget || $project.tool.name === 'pointer')

    if ($project.showGrid) {
      Grid.render(ctx)
    }

    $project.tool.render(ctx)

    requestAnimationFrame(render)
  }

  function saveImage() {
    $frame.saveImage()

    $project.update()
  }

  // const event = fn => evt => {
  //   evt.stopPropagation()

  //   const {
  //     target,
  //     buttons,
  //     offsetX,
  //     offsetY,
  //     movementX,
  //     movementY,
  //   } = evt

  //   return fn({
  //     target,
  //     buttons,
  //     movementX,
  //     movementY,
  //     offsetX: evt.offsetX,// - $layer.x,
  //     offsetY: evt.offsetY //- $layer.y,
  //   })
  // }

  function onMouseDown(evt) {
    $project.tool.mouseDown(evt)

    if ($project.tool.name === 'pointer') {
      $project.currentFrame.mouseDown(evt)
    }
  }

  function onMouseMove(evt) {
    if (evt.target === canvasEl) {
      $project.tool.mouseMove(evt)

      if ($project.tool.name === 'pointer') {
        $project.currentFrame.mouseMove(evt)
      }
    }
  }

  function onMouseOver(evt) {
    isTarget = true
  }

  function onMouseLeave(evt) {
    isTarget = false

    const isMouseDown = evt.buttons === 1

    $project.currentFrame.mouseLeave(evt)

    if (isMouseDown) { saveImage() }
  }

  function onMouseUp(evt) {
    $project.tool.mouseUp(evt)

    // $layer.mouseUp(evt)
    $project.currentFrame.mouseUp(evt)

    return saveImage()
  }

  function outsideClick(evt) {
    $store.activeLayerIds = []
  }

  const move = (x, y) => evt => {
    evt.preventDefault()

    // Switch frames
    if (evt.metaKey || evt.ctrlKey) {
      $project.frameIndex += x
    }

    // Move layer
    else {
      let multiplier = evt.shiftKey ? 5 : 1

      let ids = $store.activeLayerIds

      for (let id of $store.activeLayerIds) {
        $project.currentFrame.layers[id]._x += x * PIXEL_SIZE * multiplier
        $project.currentFrame.layers[id]._y += y * PIXEL_SIZE * multiplier
      }
    }
  }

  const tool = name => () => $project.setTool(name)

  const changeZIndices = direction => evt => {
    if (!evt.metaKey && !evt.ctrlKey) return false

    evt.preventDefault()

    $project.currentFrame.changeZIndices($store.activeLayerIds, direction)

    $project.update()
  }

  function destroyActiveLayers() {
    $project.currentFrame.destroyLayers($store.activeLayerIds)

    $store.activeLayerIds = []
  }

  const destroy = evt => {
    // Delete frame
    if (evt.metaKey || evt.ctrlKey) {
      $project.deleteFrame()
    }
    // Delete layer
    else {
      $project.currentFrame.destroyLayers($store.activeLayerIds)

      $store.activeLayerIds = []

      $project.update()
    }
  }

  const addFrame = duplicate => evt => {
    if (!evt.metaKey && !evt.ctrlKey) return false

    evt.preventDefault()

    let after = !evt.shiftKey

    $project.addFrame(after, duplicate)
  }

  // Config w/ modifiers â€” meta, ctrl, shift
  const KEYS = {
    // Backspace
    8: destroy,

    // Escape
    27: () => {
      if ($store.activeLayerIds.length === 0) {
        $project.setTool('pointer')
      }
      else {
        $store.activeLayerIds = []
      }
    },

    // Layers

    // Left arrow
    37: move(-1, 0),
    // Up arrow
    38: move(0, -1),
    // Right arrow
    39: move(1, 0),
    // Down arrow
    40: move(0, 1),

    219: changeZIndices(1),
    221: changeZIndices(-1),

    // Frame

    65: addFrame(false),
    68: addFrame(true),

    // Tools

    // p
    80: tool('pointer'),
    // b
    66: tool('brush'),
    // r
    82: tool('rectangle'),
    // o
    79: tool('ellipse'),
    // l
    76: tool('line'),
    // f
    70: tool('fill'),


  }

  function keypress(evt) {
    let fn = KEYS[evt.keyCode]

    fn && fn(evt)
  }
</script>

<svelte:window on:mousemove|stopPropagation={ onMouseMove } on:click={ outsideClick } on:keydown={ keypress } />

<div class="select-none relative bg-white z-0" style="width: { CANVAS_SIZE }px; height: { CANVAS_SIZE }px;">
  <!-- Show checkered transparent background? IDKKK -->
  <img src="/images/grid/transparent.png" class="absolute inset-0" alt="Transparent checkered grid.">

  {#if $project.showUnderlay && $project.frameIndex > 0 }
     <img src={ $project.previousFrame.image.src } class="absolute z-0 inset-0 opacity-25" alt="Previous frame underlay.">
  {/if}

  <canvas
    bind:this={ canvasEl }
    width={  CANVAS_SIZE * SCALE }
    height={ CANVAS_SIZE * SCALE }
    style="width: { CANVAS_SIZE }px; height: { CANVAS_SIZE }px;"
    class="absolute inset-0 z-0 cursor-{ $project.tool.cursor } pointer-events-auto"
    on:mousedown|stopPropagation={ onMouseDown }
    on:mouseup|stopPropagation={ onMouseUp }
    on:mouseover|stopPropagation={ onMouseOver }
    on:mouseleave|stopPropagation={ onMouseLeave }
    on:click|stopPropagation
  />

  {#if canvasEl }
    <ImageUpload bind:canvasEl />
  {/if}
</div>

<style>
  .cursor-fill {
    cursor: url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 180 160" fill="black" xmlns="http://www.w3.org/2000/svg"><path d="M80 0H100V20H120V40H140V100H100V80H180V120H160V140H140V160H100V140H80V120H60V100H40V80H20V60H40V40H60V20H80V0Z" /><path d="M20 20H60V40H40V60H20V120H0V40H20V20Z" /><path d="M120 20H160V40H120V20Z" fill="%23D8D8D8"/><path d="M160 40H180V60H160V40Z" fill="%23ACACAC"/><path d="M140 60H160V80H140V60Z" fill="%23ACACAC"/><path d="M100 80H140V100H100V80Z" fill="%23ACACAC"/></svg>') 0 15, auto;
  }
</style>