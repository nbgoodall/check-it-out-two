<script>
  import { onMount } from 'svelte'

  import { get } from 'svelte/store'

  import { PIXEL_SIZE, CANVAS_SIZE, SCALE } from 'config/constants'

  import tools from 'tools'

  import { ImageUpload } from 'components'

  import { Grid, Shortcut } from 'models'

  import { project, frame, store, mouse } from 'store'

  let canvasEl, ctx, isTarget = false

  $: tool = tools[$store.tool]

  onMount(() => {
    ctx = canvasEl.getContext('2d')

    ctx.scale(SCALE, SCALE)

    render()
  })

  function render() {
    $frame.render(ctx, null, !isTarget || tool.name === 'pointer')

    if ($project.showGrid) {
      Grid.render(ctx)
    }

    tool.render(ctx)

    requestAnimationFrame(render)
  }

  function onMouseDown(evt) {
    tool.mouseDown(evt)
  }

  function onMouseMove(evt) {
    if (evt.target === canvasEl) {
      mouse.set({ x: evt.offsetX, y: evt.offsetY, buttons: evt.buttons })

      tool.mouseMove(evt)
    }
  }

  function onMouseOver(evt) {
    isTarget = true
  }

  function onMouseLeave(evt) {
    isTarget = false

    tool.mouseLeave(evt)
  }

  function onMouseUp(evt) {
    tool.mouseUp(evt)

    $project.currentFrame.saveImage()

    for (let id of $frame.layerIds) {
      $frame.layers[id].updateBounds()
      $frame.layers[id].resetCoords()
    }

    $project.update()
  }

  function onKeydown(evt) {
    (tool.keydown && tool.keydown(evt)) || Shortcut.call(evt)
  }

  function outsideClick(evt) {
    $store.activeLayerIds = []
  }
</script>

<svelte:window on:mousemove|stopPropagation={ onMouseMove } on:click={ outsideClick } on:keydown={ onKeydown } />

<div class="select-none relative bg-white z-0" style="width: { CANVAS_SIZE }px; height: { CANVAS_SIZE }px;">
  <!-- Show checkered transparent background? IDKKK -->
  <img src="/images/grid/transparent.png" class="absolute inset-0" alt="Transparent checkered grid.">

  {#if $project.showUnderlay && $store.activeFrameIds[0] !== $project.frameIds[0] }
     <img src={ $project.previousFrame.image.src } class="absolute z-0 inset-0 opacity-25" alt="Previous frame underlay.">
  {/if}

  <canvas
    bind:this={ canvasEl }
    width={  CANVAS_SIZE * SCALE }
    height={ CANVAS_SIZE * SCALE }
    style="width: { CANVAS_SIZE }px; height: { CANVAS_SIZE }px;"
    class="absolute inset-0 z-0 cursor-{ tool.cursor } pointer-events-auto"
    on:mousedown|stopPropagation={ onMouseDown }
    on:mouseup|stopPropagation={ onMouseUp }
    on:mouseover|stopPropagation={ onMouseOver }
    on:mouseleave|stopPropagation={ onMouseLeave }
    on:click|stopPropagation
  />

  {#if canvasEl }
    <ImageUpload bind:canvasEl />
  {/if}
</div>

<style>
  .cursor-fill {
    cursor: url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 180 160" fill="black" xmlns="http://www.w3.org/2000/svg"><path d="M80 0H100V20H120V40H140V100H100V80H180V120H160V140H140V160H100V140H80V120H60V100H40V80H20V60H40V40H60V20H80V0Z" /><path d="M20 20H60V40H40V60H20V120H0V40H20V20Z" /><path d="M120 20H160V40H120V20Z" fill="%23D8D8D8"/><path d="M160 40H180V60H160V40Z" fill="%23ACACAC"/><path d="M140 60H160V80H140V60Z" fill="%23ACACAC"/><path d="M100 80H140V100H100V80Z" fill="%23ACACAC"/></svg>') 0 15, auto;
  }
</style>