<script>
  import { DEFAULT_COLORS } from 'config/constants'

  import { project } from 'store'

  let color = $project.color

  function addColor(evt) {
    color = evt.target.value.toUpperCase()

    // Gif export pure black fix; hacky AF I know.
    if (color === '#000000') {
      color = '#00000F'
    }

    $project.color = color
  }

  const COLOR_REGEX = /^([0-9A-F]{3}|[0-9A-F]{6})$/i

  function changeColor({ target }) {
    // console.log(target.value)
    let newColor = target.value.trim().replace(/#/, '')

    if (newColor.match(COLOR_REGEX)) {
      color = '#' + newColor.toUpperCase().repeat(6 * Math.pow(newColor.length, -1))
    }
  }
</script>

<div class="mt-2">
  <div class="flex items-center">
    <!-- Color picker -->
    <div class="relative w-8 h-8 shadow-lg">
      <input
        type="color"
        class="absolute inset-0 block w-full h-full appearance-none focus:outline-none cursor-pointer"
        value={ $project.color == 'transparent' ? '#FFFFFF' : color }
        on:change={ addColor }
      />
    </div>
    <!-- End color picker -->

    <!-- Color hex entry -->
    <div class="ml-3">
      <input
        type="text" value={ $project.color }
        on:input|stopPropagation={ changeColor }
        on:keydown={ ({ key }) => (key === 'Enter') && ($project.color = color) }
        on:focus={ evt => evt.target.select() }
        on:blur={ () => $project.color = color }
        class="text-base w-full appearance-none border-1 border-transparent bg-transparent focus:outline-none"
      >
    </div>
    <!-- End color hex entry-->
  </div>

  <!-- Project colors -->
  <h3 class="text-sm mt-3 font-light">Project colors</h3>

  <div class="flex flex-wrap w-56 -ml-1">
    {#each $project.colors as _color }
      <button class="w-6 h-6 ml-1 mt-1 focus:outline-none" style="background-color: { _color };" on:click|stopPropagation={ () => { $project.color = _color; color = _color }} />
    {/each}
  </div>
  <!-- End project colors -->

  <!-- Starter colors -->
  <h3 class="text-sm mt-3 font-light">Starter colors</h3>

  <div class="flex flex-wrap w-56 -ml-1">
    {#each Object.values(DEFAULT_COLORS) as _color }
      <button class="w-6 h-6 ml-1 mt-1 focus:outline-none" style="background-color: { _color };" on:click|stopPropagation={ () => { $project.color = _color; color = _color }} />
    {/each}
  </div>
  <!-- End starter colors -->
</div>