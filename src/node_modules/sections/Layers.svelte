<script>
  import { SortableList } from 'components'

  import { project, frame, store } from 'store'

  import tools from 'tools'

  import { SortLayers } from 'commands'

  import { minMax } from 'lib/arrays'

  $: layerIds = $project.currentFrame.layerIds

  function sortLayers(evt) {
    const { oldIndex, newIndex } = evt.detail

    const layerId = layerIds[oldIndex],
            delta = newIndex - oldIndex

    SortLayers.perform({ frame: $project.currentFrame, layerIds: [layerId], delta })

    return $project.update()
  }

  const selectLayer = (layerId, index) => evt => {
    // Select multiple
    if (evt.metaKey || evt.ctrlKey) {
      let index = $store.activeLayerIds.indexOf(layerId)

      if (index !== -1) {
        $store.activeLayerIds.splice(index, 1)
      }
      else {
        $store.activeLayerIds.push(layerId)
      }
      if ($store.activeLayerIds.length > 1) {
        $store.tool = 'pointer'
      }
    }
    // Select range
    else if (evt.shiftKey) {
      let lastSelection = $store.activeLayerIds[$store.activeLayerIds.length - 1]

      let lastIndex = layerIds.indexOf(lastSelection)

      let [min, max] = minMax(index, lastIndex)

      if (index > lastIndex) {
        min += 1
        max += 1
      }

      $store.activeLayerIds.push(...layerIds.slice(min, max))

      $store.tool = 'pointer'
    }
    else {
      $store.activeLayerIds = [layerId]
    }

    return $project.update()
  }

  const hoverLayer = (layerId, hover) => evt => {
    $store.hoveringIds = hover ? [layerId] : []
  }

</script>

<div class="relative max-w-full w-56 h-full overflow-scroll border-2 mt-2">
  <div class="absolute inset-0">
    {#if $project.currentFrame.layerIds.length > 0 }
      <SortableList
        key={ null }
        list={ $project.currentFrame.layerIds }
        on:sort={ sortLayers }
        let:item={ layerId }
        let:index
      >
        <div
          class="
            bg-gray-100 px-3 py-2 m-1 border-2 cursor-move
            { $store.hoveringIds.includes(layerId) && 'border-green-300' }
            { $store.activeLayerIds.includes(layerId) ? 'border-green-500' : 'hover:border-green-300' }
          "
          on:click|stopPropagation={ selectLayer(layerId, index) }
          on:mouseover={ hoverLayer(layerId, true) }
          on:mouseleave={ hoverLayer(layerId, false) }
        >
          <p>Layer { layerId }</p>
        </div>
      </SortableList>
    {/if}
  </div>
</div>