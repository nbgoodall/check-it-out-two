<script>
  import { onMount, createEventDispatcher } from 'svelte';
  import { quintOut } from 'svelte/easing';
  import { crossfade } from 'svelte/transition';
  import { flip } from 'svelte/animate';

  import Sortable from 'sortablejs';

  export let list, key, className = '';

  let listEl

  const dispatch = createEventDispatcher()

  onMount(() => {
    const options = {
      ghostClass: 'opacity-25',
      onSort: function(evt) {
        dispatch('sort', evt)
      }
    }

    Sortable.create(listEl, options);
  })

  // FLIP ANIMATION
  const [send, receive] = crossfade({
    duration: d => Math.sqrt(d * 200),
    fallback(node, params) {
      const style = getComputedStyle(node);
      const transform = style.transform === 'none' ? '' : style.transform;
      return {
        duration: 600,
        easing: quintOut,
        css: t => `
          transform: ${transform} scale(${t});
          opacity: ${t}
        `
      };
    }
  });

  // UTILS
  const getKey = item => (key ? item[key] : item);
</script>

{#if list && list.length}
  <ul class="{ className }" bind:this={listEl}>
    {#each list as item, index (getKey(item))}
      <li
        in:receive={{ key: getKey(item) }}
        out:send={{ key: getKey(item) }}
        animate:flip={{ duration: 200 }}
        class="cursor-move"
      >
        <slot {item} {index} >
          <p>{ getKey(item) }</p>
        </slot>
      </li>
    {/each}
  </ul>
{/if}