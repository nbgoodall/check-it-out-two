<script>
  import { project } from 'store'

  import { AddLayer } from 'commands'

  import { importImage } from 'lib/frames'

  export let canvasEl

  let over = false

  canvasEl.on = function(listeners, callback) {
    for (let listener of listeners.split(' ')) {
      this.addEventListener(listener, callback)
    }
  }

  canvasEl.on('drag dragstart dragover dragenter dragleave dragend drop', function(evt) {
    evt.preventDefault()
    evt.stopPropagation()
  })

  canvasEl.on('dragover dragenter', function() {
    over = true
  })

  canvasEl.on('dragleave dragend drop', function() {
    over = false
  })

  canvasEl.on('drop', function(evt) {
    let file = evt.dataTransfer.files[0]

    if (file.type.match(/image/)) {
      let reader = new FileReader()

      reader.onload = async function (evt) {
        const pixels = await importImage(evt.target.result)

        AddLayer.perform($project.currentFrame, { pixels })

        return $project.currentFrame.saveImage()
      }

      reader.readAsDataURL(file);
    }
  })

</script>

<div class="pointer-events-none absolute inset-0 border-2 border-transparent { over && 'border-green-500' }">
  <div class="absolute inset-0 opacity-50 { over && 'bg-green-200' }" />

  <div class="absolute inset-0 flex">
    {#if over }
      <h2 class="text-green-900 text-3xl m-auto leading-none">Maximum effort.</h2>
    {/if}
  </div>
</div>