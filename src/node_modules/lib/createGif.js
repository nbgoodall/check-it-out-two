import GIF from 'gif.js.optimized'

import createDownload from './createDownload'

const createGif = ({
  frames,
  frameRate,
  title,
  width,
  height,
  infinite,
  progressCallback,
  colors,
  globalPalette = false
}) => new Promise(resolve => {
  let workers = (navigator || {}).hardwareConcurrency || 2,
       repeat = infinite ? 0 : -1

  let gif = new GIF({
    repeat,
    workers,
    width,
    height,
    globalPalette,
    quality: 100, // higher = lower quality; we provide the colour palette so can be poor
    // background: 0xFF0000,
    // background: '#fff',
    // transparent: 'rgba(0,0,0,0)'
    transparent: 'rgba(0,0,0,0)',
  })

  frames.forEach(frame => gif.addFrame(frame.image, { delay: frameRate * frame.repeat }))

  gif.on('progress', progressCallback)

  gif.on('abort', console.log)

  gif.on('finished', function(blob) {
    // For testing, this opens the image in a new tab which is super duper wuper handy
    // return window.open(URL.createObjectURL(blob))

    createDownload(blob, title + '.gif')

    resolve()
  })

  gif.render()
})

export default createGif