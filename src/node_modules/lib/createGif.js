import GIF from 'gif.js.optimized'

function createLink(url, title) {
  const a = document.createElement('a')

  a.style.display = 'none'
  a.href = url
  a.download = title.replace(/ /g, '_') + '.gif'

  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)

  return window.URL.revokeObjectURL(url)
}

const createGif = ({
  images,
  frameRate,
  title,
  width,
  height,
  progressCallback
}) => new Promise(resolve => {
  let gif = new GIF({
    workers: 2,
    quality: 10,
    width,
    height
  })

  images.forEach(image => gif.addFrame(image, { delay: frameRate }))

  gif.on('progress', progressCallback)

  gif.on('finished', function(blob) {
    // For testing, this opens the image in a new tab which is super duper wuper handy
    // return window.open(URL.createObjectURL(blob))

    const url = window.URL.createObjectURL(blob)

    createLink(url, title)

    resolve()
  })

  gif.render()
})

export default createGif