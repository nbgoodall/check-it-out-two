import GIF from 'gif.js.optimized'

import createDownload from './createDownload'

const createGif = ({
  frames,
  title,
  width,
  height,
  infinite,
  progressCallback,
  colors,
  transparent,
  globalPalette = false
}) => new Promise(resolve => {
  let workers = (navigator || {}).hardwareConcurrency || 2,
       repeat = infinite ? 0 : -1

  let gif = new GIF({
    repeat,
    workers,
    width,
    height,
    globalPalette,
    quality: 100, // higher = lower quality; we provide the colour palette so can be poor
    // background: '#000',
    // background: '#fff',
    // transparent: 0x00FF00
    transparent: transparent ? 'rgba(0,0,0,0)' : null
  })

  for (let [index, frame] of frames.entries()) {
    // Delay of the previous frame affects the current frame
    let lastFrame = frames[(index + frames.length - 1) % frames.length]

    gif.addFrame(frame.image, { delay: lastFrame.delay })
  }

  // frames.forEach(frame => gif.addFrame(frame.image, { delay: frame.delay }))

  gif.on('progress', progressCallback)

  gif.on('abort', console.log)

  gif.on('finished', function(blob) {
    // For testing, this opens the image in a new tab which is super duper wuper handy
    // return window.open(URL.createObjectURL(blob))

    createDownload(blob, title + '.gif')

    resolve()
  })

  gif.render()
})

export default createGif