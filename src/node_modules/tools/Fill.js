import Tool from './Tool'

import { RESOLUTION } from 'config/constants'

import { getPixelPosition } from 'lib'

class Fill extends Tool {
  constructor() {
    super()

    this.cursor = 'fill'

    this.name = 'fill'

    this.filled = []

    this.fillCount = 0

    this.fill = (...args) => {
      this.fillCount++

      return setTimeout(() => this._fill(...args), 0)
    }
  }

  decrementFillCount() {
    this.fillCount--

    if (this.fillCount === 0) {
      this.project.currentFrame.saveImage()

      this.project.update()
    }
  }

  _fill(y, x) {
    let coords = `${y}_${x}`

    if (this.filled.includes(coords)) {
      this.decrementFillCount()

      return false
    }

    this.filled.push(coords)

    const row = [
      ...this.pixels[y].slice(0, x),
      this.project.color,
      ...this.pixels[y].slice(x + 1)
    ]

    this.pixels.splice(y, 1, row)

    if (y < RESOLUTION - 1 && this.pixels[y + 1][x] == this.targetColor) {
      this.fill(y + 1, x)
    }

    if (y > 0 && this.pixels[y - 1][x] == this.targetColor) {
      this.fill(y - 1, x)
    }

    if (x < RESOLUTION - 1 && this.pixels[y][x + 1] == this.targetColor) {
      this.fill(y, x + 1)
    }

    if (x > 0 && this.pixels[y][x - 1] == this.targetColor) {
      this.fill(y, x - 1)
    }

    this.decrementFillCount()
  }

  mouseUp(evt) {
    const x = getPixelPosition(evt.offsetX),
          y = getPixelPosition(evt.offsetY)

    this.pixels = [...this.project.currentFrame.pixels]

    if (this.project.currentFrame.pixels[y][x] != this.project.color) {
      this.targetColor = this.pixels[y][x]

      this.fillCount = 0

      this.fill(y, x)

      this.filled = []
    }

    this.project.currentFrame.pixels = this.pixels

    return this.project.update()
  }
}

// Mad instance life
export default new Fill()